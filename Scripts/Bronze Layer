-- ==== 6.Drop and Create Tables ===========
-- ======== 1. crm form ====================

IF OBJECT_ID ('Bronze.crm_cust_info','U') IS NULL 
DROP TABLE Bronze.crm_cust_info


CREATE TABLE Bronze.crm_cust_info(
cst_id INT,
cst_key VARCHAR(50),
cst_firstname VARCHAR(50),
cst_lastname VARCHAR(50),
cst_material_status VARCHAR(50),
cst_gndr VARCHAR(50),
cst_create_date DATE
);

IF OBJECT_ID ('Bronze.crm_prd_info','U') IS NULL 
DROP TABLE Bronze.crm_cust_info


CREATE TABLE Bronze.crm_prd_info(
prd_id INT,
prd_key VARCHAR(50),
prd_nm VARCHAR(50),
prd_cost INT,
prd_line VARCHAR(50),
prd_start_dt DATETIME,
prd_end_date DATETIME
);


IF OBJECT_ID ('Bronze.crm_sales_details','U') IS NULL 
DROP TABLE Bronze.crm_sales_details


CREATE TABLE Bronze.crm_sales_details(
sls_ord_num VARCHAR(50),
sls_prd_key VARCHAR(50),
sls_cust_id INT,
sls_order_dt INT,
sls_ship_dt INT,
sls_due_dt INT,
sls_sales INT,
sls_quantity INT,
sls_price INT
);


-- ======== 2.erp form ====================

IF OBJECT_ID ('Bronze.erp_loc_al01','U') IS NULL 
DROP TABLE Bronze.erp_loc_al01


CREATE TABLE Bronze.erp_loc_al01(
cid VARCHAR(50),
cntry VARCHAR(50)
);

IF OBJECT_ID ('Bronze.erp_cust_az12','U') IS NULL 
DROP TABLE Bronze.erp_cust_az12

CREATE TABLE Bronze.erp_cust_az12(
cid VARCHAR(50),
bdate DATE,
gen VARCHAR(50)
);

IF OBJECT_ID ('Bronze.erp_px_cat_glv2','U') IS NULL 
DROP TABLE Bronze.erp_px_cat_glv2

CREATE TABLE Bronze.erp_px_cat_glv2(
id VARCHAR(50),
cat VARCHAR(50),
subcat VARCHAR(50),
maintainance VARCHAR(50)
);

-- 7. Truncate and bulk insert values into tables. 

-- === crm Data Bulk Loads ===


TRUNCATE TABLE Bronze.crm_cust_info;
BULK INSERT Bronze.crm_cust_info
FROM 'C:\Users\karbh\Downloads\sql-data-warehouse-project\sql-data-warehouse-project\datasets\source_crm\cust_info.csv'
WITH ( FIRSTROW=2,
FIELDTERMINATOR=',',
TABLOCK);

SELECT * FROM Bronze.crm_cust_info;
SELECT COUNT(*) AS Cust_counts FROM Bronze.crm_cust_info;

TRUNCATE TABLE Bronze.crm_prd_info;
BULK INSERT Bronze.crm_prd_info
FROM 'C:\Users\karbh\Downloads\sql-data-warehouse-project\sql-data-warehouse-project\datasets\source_crm\prd_info.csv'
WITH ( FIRSTROW=2,
FIELDTERMINATOR=',',
TABLOCK);

SELECT * FROM Bronze.crm_prd_info;
SELECT COUNT(*) AS Prd_counts FROM Bronze.crm_prd_info;


TRUNCATE TABLE Bronze.crm_sales_details;
BULK INSERT Bronze.crm_sales_details
FROM 'C:\Users\karbh\Downloads\sql-data-warehouse-project\sql-data-warehouse-project\datasets\source_crm\sales_details.csv'
WITH ( FIRSTROW=2,
FIELDTERMINATOR=',',
TABLOCK);

SELECT * FROM Bronze.crm_sales_details;
SELECT COUNT(*) AS Sales_counts FROM Bronze.crm_sales_details;

-- === erp Data Bulk Loads ===

TRUNCATE TABLE Bronze.erp_loc_al01;
BULK INSERT Bronze.erp_loc_al01
FROM 'C:\Users\karbh\Downloads\sql-data-warehouse-project\sql-data-warehouse-project\datasets\source_erp\loc_a101.csv'
WITH ( FIRSTROW=2,
FIELDTERMINATOR=',',
TABLOCK);

SELECT * FROM Bronze.erp_loc_al01;
SELECT COUNT(*) AS Loc_counts FROM Bronze.erp_loc_al01;



TRUNCATE TABLE Bronze.erp_cust_az12;
BULK INSERT Bronze.erp_cust_az12
FROM 'C:\Users\karbh\Downloads\sql-data-warehouse-project\sql-data-warehouse-project\datasets\source_erp\cust_az12.csv'
WITH ( FIRSTROW=2,
FIELDTERMINATOR=',',
TABLOCK);

SELECT * FROM Bronze.erp_cust_az12;
SELECT COUNT(*) AS Cust_counts FROM Bronze.erp_cust_az12;

TRUNCATE TABLE Bronze.erp_px_cat_glv2;
BULK INSERT Bronze.erp_px_cat_glv2
FROM 'C:\Users\karbh\Downloads\sql-data-warehouse-project\sql-data-warehouse-project\datasets\source_erp\px_cat_g1v2.csv'
WITH ( FIRSTROW=2,
FIELDTERMINATOR=',',
TABLOCK);

SELECT * FROM Bronze.erp_px_cat_glv2;
SELECT COUNT(*) AS Px_Cat_counts FROM Bronze.erp_px_cat_glv2;

-- 8.Create Procedure for all Truncate and bulk insert values into tables.

CREATE OR ALTER PROCEDURE Bronze.load_bronze AS
BEGIN

TRUNCATE TABLE Bronze.crm_cust_info;
BULK INSERT Bronze.crm_cust_info
FROM 'C:\Users\karbh\Downloads\sql-data-warehouse-project\sql-data-warehouse-project\datasets\source_crm\cust_info.csv'
WITH ( FIRSTROW=2,
FIELDTERMINATOR=',',
TABLOCK);

TRUNCATE TABLE Bronze.crm_prd_info;
BULK INSERT Bronze.crm_prd_info
FROM 'C:\Users\karbh\Downloads\sql-data-warehouse-project\sql-data-warehouse-project\datasets\source_crm\prd_info.csv'
WITH ( FIRSTROW=2,
FIELDTERMINATOR=',',
TABLOCK);

TRUNCATE TABLE Bronze.crm_sales_details;
BULK INSERT Bronze.crm_sales_details
FROM 'C:\Users\karbh\Downloads\sql-data-warehouse-project\sql-data-warehouse-project\datasets\source_crm\sales_details.csv'
WITH ( FIRSTROW=2,
FIELDTERMINATOR=',',
TABLOCK);





TRUNCATE TABLE Bronze.erp_loc_al01;
BULK INSERT Bronze.erp_loc_al01
FROM 'C:\Users\karbh\Downloads\sql-data-warehouse-project\sql-data-warehouse-project\datasets\source_erp\loc_a101.csv'
WITH ( FIRSTROW=2,
FIELDTERMINATOR=',',
TABLOCK);


TRUNCATE TABLE Bronze.erp_cust_az12;
BULK INSERT Bronze.erp_cust_az12
FROM 'C:\Users\karbh\Downloads\sql-data-warehouse-project\sql-data-warehouse-project\datasets\source_erp\cust_az12.csv'
WITH ( FIRSTROW=2,
FIELDTERMINATOR=',',
TABLOCK);

TRUNCATE TABLE Bronze.erp_px_cat_glv2;
BULK INSERT Bronze.erp_px_cat_glv2
FROM 'C:\Users\karbh\Downloads\sql-data-warehouse-project\sql-data-warehouse-project\datasets\source_erp\px_cat_g1v2.csv'
WITH ( FIRSTROW=2,
FIELDTERMINATOR=',',
TABLOCK);

END

EXEC Bronze.load_bronze;


-- 9.Create Procedure for all Truncate and bulk insert values into tables along with print statements.


CREATE OR ALTER PROCEDURE Bronze.load_bronze AS
BEGIN

PRINT '====== Starts Store Procedure for Bronze.load_bronze layer ====='

PRINT '------------------------------'
PRINT '====== Loading crm Table ====='
PRINT '------------------------------'


PRINT '====== Truncate for Bronze.crm_cust_info Table ====='
TRUNCATE TABLE Bronze.crm_cust_info;

PRINT '====== Bulk insert for Bronze.crm_cust_info Table ====='
BULK INSERT Bronze.crm_cust_info
FROM 'C:\Users\karbh\Downloads\sql-data-warehouse-project\sql-data-warehouse-project\datasets\source_crm\cust_info.csv'
WITH ( FIRSTROW=2,
FIELDTERMINATOR=',',
TABLOCK);

PRINT '====== Truncate for Bronze.crm_prd_info Table ====='
TRUNCATE TABLE Bronze.crm_prd_info;
PRINT '====== Bulk insert for Bronze.crm_prd_info Table ====='
BULK INSERT Bronze.crm_prd_info
FROM 'C:\Users\karbh\Downloads\sql-data-warehouse-project\sql-data-warehouse-project\datasets\source_crm\prd_info.csv'
WITH ( FIRSTROW=2,
FIELDTERMINATOR=',',
TABLOCK);



PRINT '====== Truncate for Bronze.crm_sales_details Table ====='
TRUNCATE TABLE Bronze.crm_sales_details;
PRINT '====== Bulk insert for Bronze.crm_sales_details Table ====='
BULK INSERT Bronze.crm_sales_details
FROM 'C:\Users\karbh\Downloads\sql-data-warehouse-project\sql-data-warehouse-project\datasets\source_crm\sales_details.csv'
WITH ( FIRSTROW=2,
FIELDTERMINATOR=',',
TABLOCK);


PRINT '------------------------------'
PRINT '====== Loading erp Table ====='
PRINT '------------------------------'


PRINT '====== Truncate for Bronze.erp_loc_al01 Table ====='
TRUNCATE TABLE Bronze.erp_loc_al01;

PRINT '====== Bulk insert for Bronze.erp_loc_al01 Table ====='
BULK INSERT Bronze.erp_loc_al01
FROM 'C:\Users\karbh\Downloads\sql-data-warehouse-project\sql-data-warehouse-project\datasets\source_erp\loc_a101.csv'
WITH ( FIRSTROW=2,
FIELDTERMINATOR=',',
TABLOCK);

PRINT '====== Truncate for Bronze.erp_cust_az12 Table ====='
TRUNCATE TABLE Bronze.erp_cust_az12;

PRINT '====== Bulk insert for Bronze.erp_cust_az12 Table ====='
BULK INSERT Bronze.erp_cust_az12
FROM 'C:\Users\karbh\Downloads\sql-data-warehouse-project\sql-data-warehouse-project\datasets\source_erp\cust_az12.csv'
WITH ( FIRSTROW=2,
FIELDTERMINATOR=',',
TABLOCK);


PRINT '====== Truncate for Bronze.erp_px_cat_glv2 Table ====='
TRUNCATE TABLE Bronze.erp_px_cat_glv2;

PRINT '====== Bulk insert for Bronze.erp_px_cat_glv2 Table ====='
BULK INSERT Bronze.erp_px_cat_glv2
FROM 'C:\Users\karbh\Downloads\sql-data-warehouse-project\sql-data-warehouse-project\datasets\source_erp\px_cat_g1v2.csv'
WITH ( FIRSTROW=2,
FIELDTERMINATOR=',',
TABLOCK);

PRINT '====== Stop Store Procedure for Bronze.load_bronze layer ====='

END

EXEC Bronze.load_bronze;




-- 10.Create Procedure for all Truncate and bulk insert values into tables along with print and try & catch statements.


CREATE OR ALTER PROCEDURE Bronze.load_bronze AS
BEGIN

BEGIN TRY

PRINT '====== Starts Store Procedure for Bronze.load_bronze layer ====='

PRINT '------------------------------'
PRINT '====== Loading crm Table ====='
PRINT '------------------------------'


PRINT '====== Truncate for Bronze.crm_cust_info Table ====='
TRUNCATE TABLE Bronze.crm_cust_info;

PRINT '====== Bulk insert for Bronze.crm_cust_info Table ====='
BULK INSERT Bronze.crm_cust_info
FROM 'C:\Users\karbh\Downloads\sql-data-warehouse-project\sql-data-warehouse-project\datasets\source_crm\cust_info.csv'
WITH ( FIRSTROW=2,
FIELDTERMINATOR=',',
TABLOCK);

PRINT '====== Truncate for Bronze.crm_prd_info Table ====='
TRUNCATE TABLE Bronze.crm_prd_info;
PRINT '====== Bulk insert for Bronze.crm_prd_info Table ====='
BULK INSERT Bronze.crm_prd_info
FROM 'C:\Users\karbh\Downloads\sql-data-warehouse-project\sql-data-warehouse-project\datasets\source_crm\prd_info.csv'
WITH ( FIRSTROW=2,
FIELDTERMINATOR=',',
TABLOCK);



PRINT '====== Truncate for Bronze.crm_sales_details Table ====='
TRUNCATE TABLE Bronze.crm_sales_details;
PRINT '====== Bulk insert for Bronze.crm_sales_details Table ====='
BULK INSERT Bronze.crm_sales_details
FROM 'C:\Users\karbh\Downloads\sql-data-warehouse-project\sql-data-warehouse-project\datasets\source_crm\sales_details.csv'
WITH ( FIRSTROW=2,
FIELDTERMINATOR=',',
TABLOCK);


PRINT '------------------------------'
PRINT '====== Loading erp Table ====='
PRINT '------------------------------'


PRINT '====== Truncate for Bronze.erp_loc_al01 Table ====='
TRUNCATE TABLE Bronze.erp_loc_al01;

PRINT '====== Bulk insert for Bronze.erp_loc_al01 Table ====='
BULK INSERT Bronze.erp_loc_al01
FROM 'C:\Users\karbh\Downloads\sql-data-warehouse-project\sql-data-warehouse-project\datasets\source_erp\loc_a101.csv'
WITH ( FIRSTROW=2,
FIELDTERMINATOR=',',
TABLOCK);

PRINT '====== Truncate for Bronze.erp_cust_az12 Table ====='
TRUNCATE TABLE Bronze.erp_cust_az12;

PRINT '====== Bulk insert for Bronze.erp_cust_az12 Table ====='
BULK INSERT Bronze.erp_cust_az12
FROM 'C:\Users\karbh\Downloads\sql-data-warehouse-project\sql-data-warehouse-project\datasets\source_erp\cust_az12.csv'
WITH ( FIRSTROW=2,
FIELDTERMINATOR=',',
TABLOCK);


PRINT '====== Truncate for Bronze.erp_px_cat_glv2 Table ====='
TRUNCATE TABLE Bronze.erp_px_cat_glv2;

PRINT '====== Bulk insert for Bronze.erp_px_cat_glv2 Table ====='
BULK INSERT Bronze.erp_px_cat_glv2
FROM 'C:\Users\karbh\Downloads\sql-data-warehouse-project\sql-data-warehouse-project\datasets\source_erp\px_cat_g1v2.csv'
WITH ( FIRSTROW=2,
FIELDTERMINATOR=',',
TABLOCK);

PRINT '====== Stop Store Procedure for Bronze.load_bronze layer ====='

END TRY

BEGIN CATCH

PRINT 'Error Message Getting'
PRINT 'Error Message :'+ERROR_MESSAGE()
PRINT 'Error Message :'+CAST(ERROR_NUMBER()AS VARCHAR)
PRINT 'Error Message :'+CAST(ERROR_STATE()AS VARCHAR)

END CATCH

END

EXEC Bronze.load_bronze;

use DataWarehouse;

-- 10.Create Procedure for all Truncate and bulk insert values into tables along with print and try & catch statements.

Drop procedure Bronze.load_bronze;

CREATE OR ALTER PROCEDURE Bronze.load_bronze AS

BEGIN
DECLARE @start_time DATETIME, @end_time DATETIME,
@batch_start_time DATETIME, @batch_end_time DATETIME

BEGIN TRY

SET @batch_start_time=GETDATE();

PRINT '====== Starts Store Procedure for Bronze.load_bronze layer =====';

PRINT '------------------------------';
PRINT '====== Loading crm Table =====';
PRINT '------------------------------';

SET @start_time=GETDATE();
PRINT '====== Truncate for Bronze.crm_cust_info Table =====';
TRUNCATE TABLE Bronze.crm_cust_info;

PRINT '====== Bulk insert for Bronze.crm_cust_info Table =====';
BULK INSERT Bronze.crm_cust_info
FROM 'C:\Users\karbh\Downloads\sql-data-warehouse-project\sql-data-warehouse-project\datasets\source_crm\cust_info.csv'
WITH ( FIRSTROW=2,
FIELDTERMINATOR=',',
TABLOCK);
SET @end_time=GETDATE();

PRINT 'Duration of time Bronze.crm_cust_info is '+ CAST(DATEDIFF(SECOND,@start_time,@end_time) AS VARCHAR)+' seconds';

SET @start_time=GETDATE();
PRINT '====== Truncate for Bronze.crm_prd_info Table =====';
TRUNCATE TABLE Bronze.crm_prd_info;
PRINT '====== Bulk insert for Bronze.crm_prd_info Table =====';
BULK INSERT Bronze.crm_prd_info
FROM 'C:\Users\karbh\Downloads\sql-data-warehouse-project\sql-data-warehouse-project\datasets\source_crm\prd_info.csv'
WITH ( FIRSTROW=2,
FIELDTERMINATOR=',',
TABLOCK);
SET @end_time=GETDATE();

PRINT 'Duration of time Bronze.crm_prd_info is '+ CAST(DATEDIFF(SECOND,@start_time,@end_time) AS VARCHAR)+' seconds';


SET @start_time=GETDATE();
PRINT '====== Truncate for Bronze.crm_sales_details Table =====';
TRUNCATE TABLE Bronze.crm_sales_details;
PRINT '====== Bulk insert for Bronze.crm_sales_details Table =====';
BULK INSERT Bronze.crm_sales_details
FROM 'C:\Users\karbh\Downloads\sql-data-warehouse-project\sql-data-warehouse-project\datasets\source_crm\sales_details.csv'
WITH ( FIRSTROW=2,
FIELDTERMINATOR=',',
TABLOCK);
SET @end_time=GETDATE();

PRINT 'Duration of time Bronze.crm_sales_details is '+ CAST(DATEDIFF(SECOND,@start_time,@end_time) AS VARCHAR)+' seconds';


PRINT '------------------------------';
PRINT '====== Loading erp Table =====';
PRINT '------------------------------';

SET @start_time=GETDATE();
PRINT '====== Truncate for Bronze.erp_loc_al01 Table =====';
TRUNCATE TABLE Bronze.erp_loc_al01;

PRINT '====== Bulk insert for Bronze.erp_loc_al01 Table =====';
BULK INSERT Bronze.erp_loc_al01
FROM 'C:\Users\karbh\Downloads\sql-data-warehouse-project\sql-data-warehouse-project\datasets\source_erp\loc_a101.csv'
WITH ( FIRSTROW=2,
FIELDTERMINATOR=',',
TABLOCK);
SET @end_time=GETDATE();

PRINT 'Duration of time Bronze.erp_loc_al01 is '+ CAST(DATEDIFF(SECOND,@start_time,@end_time) AS VARCHAR)+' seconds';


SET @start_time=GETDATE();
PRINT '====== Truncate for Bronze.erp_cust_az12 Table =====';
TRUNCATE TABLE Bronze.erp_cust_az12;

PRINT '====== Bulk insert for Bronze.erp_cust_az12 Table =====';
BULK INSERT Bronze.erp_cust_az12
FROM 'C:\Users\karbh\Downloads\sql-data-warehouse-project\sql-data-warehouse-project\datasets\source_erp\cust_az12.csv'
WITH ( FIRSTROW=2,
FIELDTERMINATOR=',',
TABLOCK);
SET @end_time=GETDATE();

PRINT 'Duration of time Bronze.erp_cust_az12 is '+ CAST(DATEDIFF(SECOND,@start_time,@end_time) AS VARCHAR)+' seconds';

SET @start_time=GETDATE();
PRINT '====== Truncate for Bronze.erp_px_cat_glv2 Table =====';
TRUNCATE TABLE Bronze.erp_px_cat_glv2;

PRINT '====== Bulk insert for Bronze.erp_px_cat_glv2 Table =====';
BULK INSERT Bronze.erp_px_cat_glv2
FROM 'C:\Users\karbh\Downloads\sql-data-warehouse-project\sql-data-warehouse-project\datasets\source_erp\px_cat_g1v2.csv'
WITH ( FIRSTROW=2,
FIELDTERMINATOR=',',
TABLOCK);
SET @end_time=GETDATE();

SET @batch_end_time=GETDATE();

PRINT 'Duration of time Bronze.erp_px_cat_glv2 is '+ CAST(DATEDIFF(SECOND,@start_time,@end_time) AS VARCHAR)+' seconds';

PRINT 'Duration of time of Bronze is '+ CAST(DATEDIFF(SECOND,@batch_start_time,@batch_end_time) AS VARCHAR)+' seconds';


PRINT '====== Stop Store Procedure for Bronze.load_bronze layer =====';

END TRY


BEGIN CATCH

PRINT 'Error Message Getting';
PRINT 'Error Message :'+ERROR_MESSAGE();
PRINT 'Error Message :'+CAST(ERROR_NUMBER()AS VARCHAR);
PRINT 'Error Message :'+CAST(ERROR_STATE()AS VARCHAR);

END CATCH

END;

EXEC Bronze.load_bronze;
